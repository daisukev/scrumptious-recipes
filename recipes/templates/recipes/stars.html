<script>
(function(){
    let initialRating
    if("{{recipe.average_rating}}"=== "None") // If there is 0 ratings, this returns "None" so have to initialize it with a 0
      initialRating =0
    else
      initialRating = '{{recipe.average_rating}}'
  recipeId = {{ recipe.id}}
  const stars = document.querySelectorAll('#recipe-' + recipeId + ' .star');
  {% if user.is_authenticated %}
    const userIsLoggedIn = true 
  {% else %}
    const userIsLoggedIn= false
  {% endif %}

  function setStars(rating) {
    let localRating = rating
    for (let i = stars.length - 1; i >= 0; i--) {
      if (localRating >= 0.5) {
        stars[i].classList.add('gold')
      }
      else{
          if(localRating >0.1){}

        //TODO: Add partial star support. add a style variable to the partial star. unless localRating <=0.1
      }
      localRating--
    }
  }
  function resetStars() {
    for (let i = 0; i < stars.length; i++)
      stars[i].classList.remove('gold')
  }

  setStars(initialRating)
  document.addEventListener("DOMContentLoaded", (event) => {

  // initialize the star rating
  async function addRating(url = "", value)
    {
      headers = new Headers()
      headers.append('X-CSRFToken', '{{csrf_token}}')
      formData = new FormData()
      formData.append('value', value)
      const res = await fetch(url,{
        method: "POST",
        body: formData,
        credentials: 'same-origin',
        headers: headers,
      })
          const jsonData = await res.json()
        console.log(jsonData)
    messageDiv = document.getElementById('message-div')
        if(jsonData.success)
  {
      messageDiv.style.setProperty('--message-color', 'var(--green-color)')
    }
    else{
      messageDiv.style.setProperty('--message-color', 'var(--red-color)')
    }
        messageDiv.innerHTML = jsonData.message
        messageDiv.style.opacity= 1
        messageDiv.classList.remove('slide-out')
        messageDiv.classList.add('slide-in')
      setTimeout(()=>{
        messageDiv.classList.remove('slide-in')
        messageDiv.classList.add('slide-out')
        messageDiv.style.opacity = 0
      }, 3000)
      
    
    return jsonData[0]
    }
  if (userIsLoggedIn) {
        let mouseoverListeners = []
        let mouseoutListeners = []
        let clickListeners = []
    stars.forEach((star, index) => {
      const mouseoverListener = (event)=>{
          resetStars()
      }
      const mouseoutListener = (event) =>{
        setStars(initialRating)
      }
      {% if user.is_authenticated %}  
      const clickListener = (event)=>{
          value = star.dataset.value[0]

              if(addRating("{% url 'create_rating' recipe_id=recipe.id user_id=user.id%}", value) ){
              setStars(initialRating) 
        } 
      }    
    {% endif %}
      
      star.addEventListener("mouseover", mouseoverListener)
      star.addEventListener("mouseout", mouseoutListener)
      star.addEventListener("click", clickListener  )

      mouseoverListeners.push({ star, mouseoverListener })
      mouseoutListeners.push({ star, mouseoutListener })
      clickListeners.push({ star, clickListener })
    })
  }
  })
})();
</script>
